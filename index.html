<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        h1 {
            color: #343a40;
            font-weight: bold;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #007bff;
            border: none;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .table th {
            background-color: #007bff;
            color: white;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f2f2f2;
        }
        #invoicePreviewContent, #paymentPreviewContent, #coveringLetterContent {
            padding: 20px;
            border: 1px solid #ddd;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">Invoice Generator</h1>

        <!-- Settings -->
        <div class="card mb-4">
            <div class="card-header">Settings</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="fiscalYear" class="form-label">Fiscal Year (Starting April 1)</label>
                        <input type="number" class="form-control" id="fiscalYear" placeholder="e.g., 2024" value="2024">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="isLeapYear" class="form-label">Leap Year?</label>
                        <input type="checkbox" class="form-check-input" id="isLeapYear" onchange="updateMonthDays()">
                        <label class="form-check-label" for="isLeapYear">Yes</label>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="invoiceFormatInput" class="form-label">Add Invoice Number Format</label>
                        <input type="text" class="form-control" id="invoiceFormatInput" placeholder="e.g., Incentive/{year}-{nextYear}/{seq}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="invoiceFormatSelect" class="form-label">Select Invoice Format</label>
                        <select class="form-control" id="invoiceFormatSelect" onchange="updateInvoiceNo()">
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>

        <!-- Invoice Form -->
        <div class="card mb-4">
            <div class="card-header">Generate New Invoice</div>
            <div class="card-body">
                <form id="invoiceForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="invoiceNo" class="form-label">Invoice No</label>
                            <input type="text" class="form-control" id="invoiceNo" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="invoiceDate" class="form-label">Date (AD)</label>
                            <input type="date" class="form-control" id="invoiceDate" required onchange="updateBSDate()">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="invoiceMonth" class="form-label">Month</label>
                            <select class="form-control" id="invoiceMonth" required onchange="updateFields()">
                                <option value="">Select Month</option>
                                <option value="April">April (01)</option>
                                <option value="May">May (02)</option>
                                <option value="June">June (03)</option>
                                <option value="July">July (04)</option>
                                <option value="August">August (05)</option>
                                <option value="September">September (06)</option>
                                <option value="October">October (07)</option>
                                <option value="November">November (08)</option>
                                <option value="December">December (09)</option>
                                <option value="January">January (10)</option>
                                <option value="February">February (11)</option>
                                <option value="March">March (12)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="daysInMonth" class="form-label">Days in Month</label>
                            <input type="number" class="form-control" id="daysInMonth" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="annualFixedCost" class="form-label">Annual Fixed Cost (NRs)</label>
                            <input type="number" class="form-control" id="annualFixedCost" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Invoice</button>
                </form>
            </div>
        </div>

        <!-- Invoice List -->
        <div class="card">
            <div class="card-header">Invoice List</div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-info" onclick="backupData()">Backup Data</button>
                    <input type="file" id="restoreFile" class="d-none" accept=".json" onchange="restoreData(event)">
                    <button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()">Restore Data</button>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Invoice No</th>
                            <th>Date</th>
                            <th>Month</th>
                            <th>Taxable Value</th>
                            <th>VAT @ 13%</th>
                            <th>Gross Invoice</th>
                            <th>Rebate @ 2%</th>
                            <th>TDS @ 10%</th>
                            <th>30% VAT Deduction</th>
                            <th>Net Receipt</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Payment Modal -->
        <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="paymentModalLabel">Record Payment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="paymentForm">
                            <input type="hidden" id="paymentInvoiceId">
                            <div class="mb-3">
                                <label for="paymentDate" class="form-label">Payment Date</label>
                                <input type="date" class="form-control" id="paymentDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="paymentAmount" class="form-label">Amount Paid (NRs)</label>
                                <input type="number" class="form-control" id="paymentAmount" required>
                            </div>
                            <button type="submit" class="btn btn-success">Save Payment</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Preview Modal -->
        <div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="invoicePreviewModalLabel">Invoice Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="invoicePreviewContent"></div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="saveAsPDF('invoice')">Save as PDF</button>
                        <button class="btn btn-success" onclick="saveAsExcel('invoice')">Save as Excel</button>
                        <button class="btn btn-secondary" onclick="printContent('invoice')">Print</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Preview Modal -->
        <div class="modal fade" id="paymentPreviewModal" tabindex="-1" aria-labelledby="paymentPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="paymentPreviewModalLabel">Payment Info Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="paymentPreviewContent"></div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="saveAsPDF('payment')">Save as PDF</button>
                        <button class="btn btn-success" onclick="saveAsExcel('payment')">Save as Excel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Covering Letter Preview Modal -->
        <div class="modal fade" id="coveringLetterModal" tabindex="-1" aria-labelledby="coveringLetterModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="coveringLetterModalLabel">Covering Letter Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="coveringLetterContent"></div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="saveAsPDF('covering')">Save as PDF</button>
                        <button class="btn btn-secondary" onclick="printContent('covering')">Print</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initial data
        let invoices = [
            { id: 1, invoiceNo: "TSC/2024-25/01", date: "2024-05-02", month: "April", daysInMonth: 30, annualFixedCost: 241667995.10, taxableValue: 19863123, vat: 2582205.99, grossInvoice: 22445328.99 }
        ];
        let payments = [];
        let settings = { fiscalYear: 2024, invoiceFormats: ["TSC/{year}-{nextYear}/{seq}"], selectedFormat: "TSC/{year}-{nextYear}/{seq}", isLeapYear: false };
        let invoiceSequence = invoices.length + 1;

        let monthDays = {
            "April": 30, "May": 31, "June": 30, "July": 31, "August": 31, "September": 30,
            "October": 31, "November": 30, "December": 31, "January": 31, "February": 28, "March": 31
        };

        // Load data on page load
        document.addEventListener("DOMContentLoaded", () => {
            loadSettings();
            renderInvoices();
            updateInvoiceFormatSelect();
            updateMonthDays();
        });

        // Save settings
        function saveSettings() {
            settings.fiscalYear = parseInt(document.getElementById("fiscalYear").value);
            settings.isLeapYear = document.getElementById("isLeapYear").checked;
            const newFormat = document.getElementById("invoiceFormatInput").value;
            if (newFormat && !settings.invoiceFormats.includes(newFormat)) {
                settings.invoiceFormats.push(newFormat);
            }
            settings.selectedFormat = document.getElementById("invoiceFormatSelect").value;
            localStorage.setItem("settings", JSON.stringify(settings));
            updateInvoiceFormatSelect();
            updateMonthDays();
            alert("Settings saved!");
        }

        // Load settings
        function loadSettings() {
            const savedSettings = localStorage.getItem("settings");
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                document.getElementById("fiscalYear").value = settings.fiscalYear;
                document.getElementById("isLeapYear").checked = settings.isLeapYear;
            }
        }

        // Update month days based on leap year
        function updateMonthDays() {
            monthDays["February"] = settings.isLeapYear ? 29 : 28;
            updateFields();
        }

        // Update invoice format select dropdown
        function updateInvoiceFormatSelect() {
            const select = document.getElementById("invoiceFormatSelect");
            select.innerHTML = "";
            settings.invoiceFormats.forEach(format => {
                const option = document.createElement("option");
                option.value = format;
                option.text = format;
                if (format === settings.selectedFormat) option.selected = true;
                select.appendChild(option);
            });
        }

        // Update fields based on month selection
        function updateFields() {
            const month = document.getElementById("invoiceMonth").value;
            const year = settings.fiscalYear;
            const nextYear = (year + 1) % 100;
            const monthIndex = Array.from(document.getElementById("invoiceMonth").options).findIndex(opt => opt.value === month);
            const seq = monthIndex < 1 ? invoiceSequence : String(monthIndex).padStart(2, "0");
            document.getElementById("invoiceNo").value = settings.selectedFormat
                .replace("{year}", year)
                .replace("{nextYear}", nextYear)
                .replace("{seq}", seq);
            document.getElementById("daysInMonth").value = monthDays[month] || "";
        }

        // Update invoice number when format changes
        function updateInvoiceNo() {
            settings.selectedFormat = document.getElementById("invoiceFormatSelect").value;
            updateFields();
        }

        // Exact AD to BS Converter
        function adToBs(adDate) {
            const ad = new Date(adDate);
            const baseAD = new Date("1943-04-14"); // BS 2000-01-01
            const daysDiff = Math.floor((ad - baseAD) / (1000 * 60 * 60 * 24));

            // BS year offset table (approximate days from 1943-04-14 to BS year start)
            const bsYearOffsets = [
                { bsYear: 2000, days: 0 }, { bsYear: 2001, days: 365 }, { bsYear: 2002, days: 730 },
                { bsYear: 2003, days: 1095 }, { bsYear: 2004, days: 1460 }, { bsYear: 2005, days: 1826 },
                { bsYear: 2006, days: 2191 }, { bsYear: 2007, days: 2556 }, { bsYear: 2008, days: 2921 },
                { bsYear: 2009, days: 3287 }, { bsYear: 2010, days: 3652 }, { bsYear: 2011, days: 4017 },
                { bsYear: 2012, days: 4382 }, { bsYear: 2013, days: 4748 }, { bsYear: 2014, days: 5113 },
                { bsYear: 2015, days: 5478 }, { bsYear: 2016, days: 5843 }, { bsYear: 2017, days: 6209 },
                { bsYear: 2018, days: 6574 }, { bsYear: 2019, days: 6939 }, { bsYear: 2020, days: 7304 },
                { bsYear: 2021, days: 7670 }, { bsYear: 2022, days: 8035 }, { bsYear: 2023, days: 8400 },
                { bsYear: 2024, days: 8765 }, { bsYear: 2025, days: 9131 }, { bsYear: 2026, days: 9496 },
                { bsYear: 2027, days: 9861 }, { bsYear: 2028, days: 10226 }, { bsYear: 2029, days: 10592 },
                { bsYear: 2030, days: 10957 }, { bsYear: 2031, days: 11322 }, { bsYear: 2032, days: 11687 },
                { bsYear: 2033, days: 12053 }, { bsYear: 2034, days: 12418 }, { bsYear: 2035, days: 12783 },
                { bsYear: 2036, days: 13148 }, { bsYear: 2037, days: 13514 }, { bsYear: 2038, days: 13879 },
                { bsYear: 2039, days: 14244 }, { bsYear: 2040, days: 14609 }, { bsYear: 2041, days: 14975 },
                { bsYear: 2042, days: 15340 }, { bsYear: 2043, days: 15705 }, { bsYear: 2044, days: 16070 },
                { bsYear: 2045, days: 16436 }, { bsYear: 2046, days: 16801 }, { bsYear: 2047, days: 17166 },
                { bsYear: 2048, days: 17531 }, { bsYear: 2049, days: 17897 }, { bsYear: 2050, days: 18262 },
                { bsYear: 2051, days: 18627 }, { bsYear: 2052, days: 18992 }, { bsYear: 2053, days: 19358 },
                { bsYear: 2054, days: 19723 }, { bsYear: 2055, days: 20088 }, { bsYear: 2056, days: 20453 },
                { bsYear: 2057, days: 20819 }, { bsYear: 2058, days: 21184 }, { bsYear: 2059, days: 21549 },
                { bsYear: 2060, days: 21914 }, { bsYear: 2061, days: 22280 }, { bsYear: 2062, days: 22645 },
                { bsYear: 2063, days: 23010 }, { bsYear: 2064, days: 23375 }, { bsYear: 2065, days: 23741 },
                { bsYear: 2066, days: 24106 }, { bsYear: 2067, days: 24471 }, { bsYear: 2068, days: 24836 },
                { bsYear: 2069, days: 25202 }, { bsYear: 2070, days: 25567 }, { bsYear: 2071, days: 25932 },
                { bsYear: 2072, days: 26297 }, { bsYear: 2073, days: 26663 }, { bsYear: 2074, days: 27028 },
                { bsYear: 2075, days: 27393 }, { bsYear: 2076, days: 27758 }, { bsYear: 2077, days: 28124 },
                { bsYear: 2078, days: 28489 }, { bsYear: 2079, days: 28854 }, { bsYear: 2080, days: 29219 },
                { bsYear: 2081, days: 29585 }, { bsYear: 2082, days: 29950 }, { bsYear: 2083, days: 30315 },
                { bsYear: 2084, days: 30680 }, { bsYear: 2085, days: 31046 }
            ];

            let bsYear, remainingDays;
            for (let i = 0; i < bsYearOffsets.length - 1; i++) {
                if (daysDiff >= bsYearOffsets[i].days && daysDiff < bsYearOffsets[i + 1].days) {
                    bsYear = bsYearOffsets[i].bsYear;
                    remainingDays = daysDiff - bsYearOffsets[i].days;
                    break;
                }
            }
            if (!bsYear) {
                bsYear = bsYearOffsets[bsYearOffsets.length - 1].bsYear;
                remainingDays = daysDiff - bsYearOffsets[bsYearOffsets.length - 1].days;
            }

            const bsMonths = [
                30, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30 // Baishakh to Chaitra
            ];
            if (bsYear % 4 === 2) bsMonths[7] = 30; // Adjust for BS leap year (e.g., 2078)

            let bsMonth = 1;
            let bsDay = 1;
            for (let i = 0; i < 12 && remainingDays >= 0; i++) {
                if (remainingDays >= bsMonths[i]) {
                    remainingDays -= bsMonths[i];
                    bsMonth++;
                } else {
                    bsDay += remainingDays;
                    remainingDays = -1;
                }
            }

            return `${bsYear}/${String(bsMonth).padStart(2, "0")}/${String(bsDay).padStart(2, "0")}`;
        }

        // Update BS date based on AD date
        function updateBSDate() {
            const adDate = document.getElementById("invoiceDate").value;
            if (adDate) {
                const bsDate = adToBs(adDate);
                document.getElementById("invoiceDate").dataset.bsDate = bsDate;
            }
        }

        // Handle invoice form submission
        document.getElementById("invoiceForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const invoiceNo = document.getElementById("invoiceNo").value;
            const invoiceDate = document.getElementById("invoiceDate").value;
            const invoiceMonth = document.getElementById("invoiceMonth").value;
            const daysInMonth = parseInt(document.getElementById("daysInMonth").value);
            const annualFixedCost = parseFloat(document.getElementById("annualFixedCost").value);

            const taxableValue = (annualFixedCost * daysInMonth / 365);
            const vat = taxableValue * 0.13;
            const grossInvoice = taxableValue + vat;

            const newInvoice = {
                id: invoices.length + 1,
                invoiceNo,
                date: invoiceDate,
                month: invoiceMonth,
                daysInMonth,
                annualFixedCost,
                taxableValue,
                vat,
                grossInvoice
            };

            invoices.push(newInvoice);
            invoiceSequence++;
            renderInvoices();
            document.getElementById("invoiceForm").reset();
        });

        // Render invoices
        function renderInvoices() {
            const tbody = document.getElementById("invoiceTableBody");
            tbody.innerHTML = "";
            invoices.forEach(invoice => {
                const rebate = invoice.grossInvoice * 0.02;
                const tds = invoice.taxableValue * 0.10;
                const vat30 = invoice.vat * 0.30;
                const netReceipt = invoice.grossInvoice - rebate - tds - vat30;

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${invoice.invoiceNo}</td>
                    <td>${invoice.date}</td>
                    <td>${invoice.month}</td>
                    <td>${invoice.taxableValue.toLocaleString()}</td>
                    <td>${invoice.vat.toLocaleString()}</td>
                    <td>${invoice.grossInvoice.toLocaleString()}</td>
                    <td>${rebate.toLocaleString()}</td>
                    <td>${tds.toLocaleString()}</td>
                    <td>${vat30.toLocaleString()}</td>
                    <td>${netReceipt.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editInvoice(${invoice.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">Delete</button>
                        <button class="btn btn-sm btn-success" onclick="openPaymentModal(${invoice.id})">Pay</button>
                        <button class="btn btn-sm btn-info" onclick="previewInvoice(${invoice.id})">Invoice Preview</button>
                        <button class="btn btn-sm btn-secondary" onclick="previewPayment(${invoice.id})">Payment Preview</button>
                        <button class="btn btn-sm btn-primary" onclick="previewCoveringLetter(${invoice.id})">Covering Letter</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit invoice
        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                document.getElementById("invoiceNo").value = invoice.invoiceNo;
                document.getElementById("invoiceDate").value = invoice.date;
                document.getElementById("invoiceMonth").value = invoice.month;
                document.getElementById("daysInMonth").value = invoice.daysInMonth;
                document.getElementById("annualFixedCost").value = invoice.annualFixedCost;
                deleteInvoice(id);
            }
        }

        // Delete invoice
        function deleteInvoice(id) {
            invoices = invoices.filter(inv => inv.id !== id);
            renderInvoices();
        }

        // Open payment modal
        function openPaymentModal(id) {
            document.getElementById("paymentInvoiceId").value = id;
            const modal = new bootstrap.Modal(document.getElementById("paymentModal"));
            modal.show();
        }

        // Handle payment form submission
        document.getElementById("paymentForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const invoiceId = parseInt(document.getElementById("paymentInvoiceId").value);
            const paymentDate = document.getElementById("paymentDate").value;
            const paymentAmount = parseFloat(document.getElementById("paymentAmount").value);
            const invoice = invoices.find(inv => inv.id === invoiceId);

            if (invoice) {
                const rebate = invoice.grossInvoice * 0.02;
                const tds = invoice.taxableValue * 0.10;
                const vat30 = invoice.vat * 0.30;
                const netPayment = invoice.grossInvoice - (rebate + tds + vat30);

                payments.push({
                    invoiceId,
                    paymentDate,
                    paymentAmount,
                    rebate,
                    tds,
                    vat30,
                    netPayment
                });
                alert(`Payment of NRs ${paymentAmount} recorded for Invoice ${invoice.invoiceNo}`);
            }
            document.getElementById("paymentForm").reset();
            bootstrap.Modal.getInstance(document.getElementById("paymentModal")).hide();
        });

        // Preview invoice
        function previewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const content = `
                <div class="invoice">
                    <h3>Power Transmission Company Nepal Limited</h3>
                    <p>Corporate Office: Lalitpur sub metropolitan city-2, Sanepa, Lalitpur, Nepal</p>
                    <p>Phone: +977-1-5544948, 5531907 | Fax: +977-1.5544948</p>
                    <p>PAN: 302889592</p>
                    <hr>
                    <h4>Invoice</h4>
                    <p><strong>To:</strong> Nepal Electricity Authority, Dubarmarg, Kathmandu, Nepal</p>
                    <p><strong>Invoice No:</strong> ${invoice.invoiceNo}</p>
                    <p><strong>Invoice Month:</strong> ${invoice.month}</p>
                    <p><strong>Date:</strong> ${invoice.date}</p>
                    <hr>
                    <h5>Amounts in NRs</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Annual Fixed Cost for the Year</td>
                                <td>${invoice.annualFixedCost.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Number of Days in the Month</td>
                                <td>${invoice.daysInMonth}</td>
                            </tr>
                            <tr>
                                <td>Taxable Value</td>
                                <td>${invoice.taxableValue.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>VAT @ 13%</td>
                                <td>${invoice.vat.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Gross Invoice</td>
                                <td>${invoice.grossInvoice.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                    <hr>
                    <p><strong>Bank Details:</strong></p>
                    <p>Name of the Bank: Sanima Bank Limited</p>
                    <p>Branch Address: Newroad, Kathmandu</p>
                    <p>Account No: 003010010000710</p>
                    <p><strong>For Power Transmission Company Nepal Limited</strong></p>
                    <p>Authorised Signatory</p>
                    <p><strong>Note:</strong></p>
                    <p>1. The above Transmission Service Charges have been computed based on the Normative Availability @95% as per provision of Clause 9.6 of Section 9 of ITSA dtd 13th Dec, 2011.</p>
                </div>
            `;
            document.getElementById("invoicePreviewContent").innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById("invoicePreviewModal"));
            modal.show();
        }

        // Preview payment
        function previewPayment(id) {
            const invoice = invoices.find(inv => inv.id === id);
            const payment = payments.find(p => p.invoiceId === id) || {};
            if (!invoice) return;

            const rebate = invoice.grossInvoice * 0.02;
            const tds = invoice.taxableValue * 0.10;
            const vat30 = invoice.vat * 0.30;
            const netPayment = invoice.grossInvoice - (rebate + tds + vat30);

            const content = `
                <div class="payment">
                    <h3>Power Transmission Company Nepal Limited</h3>
                    <p>Corporate Office: Lalitpur sub metropolitan city-2, Sanepa, Lalitpur, Nepal</p>
                    <p>Phone: +977-1-5544948, 5531907 | Fax: +977-1.5544948</p>
                    <p>PAN: 302889592</p>
                    <hr>
                    <h4>Payment Information</h4>
                    <p><strong>Invoice No:</strong> ${invoice.invoiceNo}</p>
                    <p><strong>Payment Date:</strong> ${payment.paymentDate || "Not Paid"}</p>
                    <hr>
                    <h5>Amounts in NRs</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Gross Invoice</td>
                                <td>${invoice.grossInvoice.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Rebate @ 2%</td>
                                <td>${rebate.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>TDS @ 10%</td>
                                <td>${tds.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>30% VAT Deduction</td>
                                <td>${vat30.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Net Payment</td>
                                <td>${netPayment.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Amount Paid</td>
                                <td>${payment.paymentAmount ? payment.paymentAmount.toLocaleString() : "N/A"}</td>
                            </tr>
                        </tbody>
                    </table>
                    <hr>
                    <p><strong>Bank Details:</strong></p>
                    <p>Name of the Bank: Sanima Bank Limited</p>
                    <p>Branch Address: Newroad, Kathmandu</p>
                    <p>Account No: 003010010000710</p>
                </div>
            `;
            document.getElementById("paymentPreviewContent").innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById("paymentPreviewModal"));
            modal.show();
        }

        // Preview covering letter
        function previewCoveringLetter(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const amountWords = numberToWords(invoice.grossInvoice);
            const bsDate = adToBs(invoice.date);
            const content = `
                <div class="covering-letter">
                    <p><strong>Our Ref No. 2080/81 -</strong> <span style="float: right;">Miti: ${bsDate}<br>Date: ${invoice.date}</span></p>
                    <p>The Managing Director<br>Nepal Electricity Authority<br>Durbar Marg, Kathmandu<br>NEPAL</p>
                    <p><strong>Sub:-</strong> Transmission Service Charges for Dhalkebar - Bhittamod 400 kV D/C Transmission Line (Nepal Portion of Dhalkebar - Muzaffarpur -400 kV D/C Transmission Line) – Invoice No. ${invoice.invoiceNo}</p>
                    <p>Dear Sir,</p>
                    <p>This has reference to the “Implementation & Transmission Service Agreement” signed between NEA & PTCN on December 13, 2011 for TLP-Nepal.</p>
                    <p>As per Section-10 (Payment and Billing of Transmission Service Charges) of the said Agreement, we are enclosing herewith Invoice No. ${invoice.invoiceNo} dated ${invoice.date} for NRs. ${invoice.grossInvoice.toLocaleString()} /- (In Words ${amountWords}) for Transmission Service Charges for the month of ${invoice.month}-2024.</p>
                    <p>You are, therefore, requested to release the above-mentioned amount of NRs. ${invoice.grossInvoice.toLocaleString()} /- in favour of PTCN at the earliest.</p>
                    <p>Encl: as above</p>
                    <p>Thanking you,</p>
                    <p>Yours sincerely,</p>
                    <br><br>
                    <p>……………………………<br>(Santosh Phuyal)<br>Chief Finance Officer<br>Power Transmission Company Nepal Limited</p>
                    <p><strong>Cc:</strong> DMD (Finance Directorate)<br>NEA, Durbar Marg, Kathmandu</p>
                </div>
            `;
            document.getElementById("coveringLetterContent").innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById("coveringLetterModal"));
            modal.show();
        }

        // Number to words with high precision
        function numberToWords(num) {
            const units = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
            const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
            const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
            const thousands = ["", "Thousand", "Million", "Billion", "Trillion"];

            const integerPart = Math.floor(num);
            const decimalPart = Math.round((num - integerPart) * 10000); // Up to 4 decimal places

            let integerWords = [];
            if (integerPart === 0) {
                integerWords.push("Zero");
            } else {
                let tempNum = integerPart;
                let chunkCount = 0;
                while (tempNum > 0) {
                    let chunk = tempNum % 1000;
                    if (chunk) {
                        let chunkWords = [];
                        if (chunk >= 100) {
                            chunkWords.push(units[Math.floor(chunk / 100)] + " Hundred");
                            chunk %= 100;
                        }
                        if (chunk >= 20) {
                            chunkWords.push(tens[Math.floor(chunk / 10)]);
                            chunk %= 10;
                        }
                        if (chunk >= 10 && chunk < 20) {
                            chunkWords.push(teens[chunk - 10]);
                            chunk = 0;
                        }
                        if (chunk > 0) {
                            chunkWords.push(units[chunk]);
                        }
                        integerWords.unshift(chunkWords.join(" ") + " " + thousands[chunkCount]);
                    }
                    tempNum = Math.floor(tempNum / 1000);
                    chunkCount++;
                }
            }

            let words = integerWords.join(" ").trim() + " Rupees";
            if (decimalPart > 0) {
                let decimalWords = [];
                let tempDecimal = decimalPart;
                for (let i = 0; i < 4 && tempDecimal > 0; i++) {
                    let digit = Math.floor(tempDecimal / Math.pow(10, 3 - i));
                    if (digit > 0) {
                        if (digit >= 20) {
                            decimalWords.push(tens[Math.floor(digit / 10)]);
                            digit %= 10;
                        }
                        if (digit >= 10 && digit < 20) {
                            decimalWords.push(teens[digit - 10]);
                            digit = 0;
                        }
                        if (digit > 0) {
                            decimalWords.push(units[digit]);
                        }
                    }
                    tempDecimal = tempDecimal % Math.pow(10, 3 - i);
                }
                words += " and " + decimalWords.join(" ") + " Paisa";
            }
            return words + " Only";
        }

        // Save as PDF
        function saveAsPDF(type) {
            const element = type === "invoice" ? document.getElementById("invoicePreviewContent") :
                           type === "payment" ? document.getElementById("paymentPreviewContent") :
                           document.getElementById("coveringLetterContent");
            html2pdf().from(element).save(`${type}.pdf`);
        }

        // Print content
        function printContent(type) {
            const element = type === "invoice" ? document.getElementById("invoicePreviewContent") :
                           document.getElementById("coveringLetterContent");
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Print</title></head><body>');
            printWindow.document.write(element.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        // Save as Excel
        function saveAsExcel(type) {
            if (type === "invoice") {
                const invoiceData = invoices.map(inv => ({
                    "Invoice No": inv.invoiceNo,
                    "Date": inv.date,
                    "Month": inv.month,
                    "Annual Fixed Cost": inv.annualFixedCost,
                    "Days in Month": inv.daysInMonth,
                    "Taxable Value": inv.taxableValue,
                    "VAT @ 13%": inv.vat,
                    "Gross Invoice": inv.grossInvoice
                }));
                const ws = XLSX.utils.json_to_sheet(invoiceData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Invoice");
                XLSX.writeFile(wb, "invoice.xlsx");
            } else {
                const paymentData = payments.map(p => {
                    const inv = invoices.find(i => i.id === p.invoiceId);
                    return {
                        "Invoice No": inv.invoiceNo,
                        "Payment Date": p.paymentDate,
                        "Gross Invoice": inv.grossInvoice,
                        "Rebate @ 2%": p.rebate,
                        "TDS @ 10%": p.tds,
                        "30% VAT Deduction": p.vat30,
                        "Net Payment": p.netPayment,
                        "Amount Paid": p.paymentAmount
                    };
                });
                const ws = XLSX.utils.json_to_sheet(paymentData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Payment");
                XLSX.writeFile(wb, "payment.xlsx");
            }
        }

        // Backup data
        function backupData() {
            const data = { invoices, payments, settings, invoiceSequence };
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "invoice_backup.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        // Restore data
        function restoreData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = JSON.parse(e.target.result);
                    invoices = data.invoices || [];
                    payments = data.payments || [];
                    settings = data.settings || settings;
                    invoiceSequence = data.invoiceSequence || invoices.length + 1;
                    localStorage.setItem("settings", JSON.stringify(settings));
                    renderInvoices();
                    updateInvoiceFormatSelect();
                    updateMonthDays();
                    alert("Data restored successfully!");
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
