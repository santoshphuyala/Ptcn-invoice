<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        h1 {
            color: #343a40;
            font-weight: bold;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #007bff;
            border: none;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .table th {
            background-color: #007bff;
            color: white;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f2f2f2;
        }
        #invoicePreviewContent, #paymentPreviewContent {
            padding: 20px;
            border: 1px solid #ddd;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center mb-4">Invoice Generator</h1>

        <!-- Fiscal Year & Invoice Format -->
        <div class="card mb-4">
            <div class="card-header">Settings</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fiscalYear" class="form-label">Fiscal Year (Starting April 1)</label>
                        <input type="number" class="form-control" id="fiscalYear" placeholder="e.g., 2024" value="2024">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="invoiceFormat" class="form-label">Invoice Number Format</label>
                        <input type="text" class="form-control" id="invoiceFormat" value="TSC/{year}-{nextYear}/{seq}">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>

        <!-- Invoice Form -->
        <div class="card mb-4">
            <div class="card-header">Generate New Invoice</div>
            <div class="card-body">
                <form id="invoiceForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="invoiceNo" class="form-label">Invoice No</label>
                            <input type="text" class="form-control" id="invoiceNo" required onchange="autoFillFields()">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="invoiceDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="invoiceDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="invoiceMonth" class="form-label">Month</label>
                            <select class="form-control" id="invoiceMonth" required onchange="updateDays()">
                                <option value="">Select Month</option>
                                <option value="April">April (01)</option>
                                <option value="May">May (02)</option>
                                <option value="June">June (03)</option>
                                <option value="July">July (04)</option>
                                <option value="August">August (05)</option>
                                <option value="September">September (06)</option>
                                <option value="October">October (07)</option>
                                <option value="November">November (08)</option>
                                <option value="December">December (09)</option>
                                <option value="January">January (10)</option>
                                <option value="February">February (11)</option>
                                <option value="March">March (12)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="daysInMonth" class="form-label">Days in Month</label>
                            <input type="number" class="form-control" id="daysInMonth" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="annualFixedCost" class="form-label">Annual Fixed Cost (NRs)</label>
                            <input type="number" class="form-control" id="annualFixedCost" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Invoice</button>
                </form>
            </div>
        </div>

        <!-- Invoice List -->
        <div class="card">
            <div class="card-header">Invoice List</div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-info" onclick="backupData()">Backup Data</button>
                    <input type="file" id="restoreFile" class="d-none" accept=".json" onchange="restoreData(event)">
                    <button class="btn btn-warning" onclick="document.getElementById('restoreFile').click()">Restore Data</button>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Invoice No</th>
                            <th>Date</th>
                            <th>Month</th>
                            <th>Taxable Value</th>
                            <th>VAT @ 13%</th>
                            <th>Gross Invoice</th>
                            <th>Rebate @ 2%</th>
                            <th>TDS @ 10%</th>
                            <th>30% VAT Deduction</th>
                            <th>Net Receipt</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Payment Modal -->
        <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="paymentModalLabel">Record Payment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="paymentForm">
                            <input type="hidden" id="paymentInvoiceId">
                            <div class="mb-3">
                                <label for="paymentDate" class="form-label">Payment Date</label>
                                <input type="date" class="form-control" id="paymentDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="paymentAmount" class="form-label">Amount Paid (NRs)</label>
                                <input type="number" class="form-control" id="paymentAmount" required>
                            </div>
                            <button type="submit" class="btn btn-success">Save Payment</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Preview Modal -->
        <div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="invoicePreviewModalLabel">Invoice Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="invoicePreviewContent"></div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="saveAsPDF('invoice')">Save as PDF</button>
                        <button class="btn btn-success" onclick="saveAsExcel('invoice')">Save as Excel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Preview Modal -->
        <div class="modal fade" id="paymentPreviewModal" tabindex="-1" aria-labelledby="paymentPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="paymentPreviewModalLabel">Payment Info Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="paymentPreviewContent"></div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="saveAsPDF('payment')">Save as PDF</button>
                        <button class="btn btn-success" onclick="saveAsExcel('payment')">Save as Excel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initial data from the document
        let invoices = [
            { id: 1, invoiceNo: "TSC/2024-25/01", date: "2024-05-02", month: "April", daysInMonth: 30, annualFixedCost: 241667995.10, taxableValue: 19863123, vat: 2582205.99, grossInvoice: 22445328.99 },
            { id: 2, invoiceNo: "OPGW/2075-76/02", date: "2076-03-31", month: "Ashadh", daysInMonth: 30, annualFixedCost: 510000, taxableValue: 41917.81, vat: 5449.32, grossInvoice: 47367.13 }
        ];
        let payments = [];
        let settings = { fiscalYear: 2024, invoiceFormat: "TSC/{year}-{nextYear}/{seq}" };
        let invoiceSequence = invoices.length + 1;

        const monthDays = {
            "April": 30, "May": 31, "June": 30, "July": 31, "August": 31, "September": 30,
            "October": 31, "November": 30, "December": 31, "January": 31, "February": 28, "March": 31
        };

        // Load data on page load
        document.addEventListener("DOMContentLoaded", () => {
            loadSettings();
            renderInvoices();
        });

        // Save settings
        function saveSettings() {
            settings.fiscalYear = parseInt(document.getElementById("fiscalYear").value);
            settings.invoiceFormat = document.getElementById("invoiceFormat").value;
            localStorage.setItem("settings", JSON.stringify(settings));
            alert("Settings saved!");
        }

        // Load settings
        function loadSettings() {
            const savedSettings = localStorage.getItem("settings");
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                document.getElementById("fiscalYear").value = settings.fiscalYear;
                document.getElementById("invoiceFormat").value = settings.invoiceFormat;
            }
        }

        // Auto-fill fields based on invoice number
        function autoFillFields() {
            const invoiceNo = document.getElementById("invoiceNo").value;
            const match = invoiceNo.match(/(\d{4})-(\d{2})\/(\d+)/);
            if (match) {
                const seq = parseInt(match[3]);
                const months = ["April", "May", "June", "July", "August", "September", "October", "November", "December", "January", "February", "March"];
                const monthIndex = seq - 1;
                if (monthIndex >= 0 && monthIndex < 12) {
                    document.getElementById("invoiceMonth").value = months[monthIndex];
                    document.getElementById("daysInMonth").value = monthDays[months[monthIndex]];
                }
            }
        }

        // Update days based on selected month
        function updateDays() {
            const month = document.getElementById("invoiceMonth").value;
            document.getElementById("daysInMonth").value = monthDays[month] || "";
        }

        // Handle invoice form submission
        document.getElementById("invoiceForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const invoiceNo = document.getElementById("invoiceNo").value || generateInvoiceNo();
            const invoiceDate = document.getElementById("invoiceDate").value;
            const invoiceMonth = document.getElementById("invoiceMonth").value;
            const daysInMonth = parseInt(document.getElementById("daysInMonth").value);
            const annualFixedCost = parseFloat(document.getElementById("annualFixedCost").value);

            const taxableValue = (annualFixedCost * daysInMonth / 365);
            const vat = taxableValue * 0.13;
            const grossInvoice = taxableValue + vat;

            const newInvoice = {
                id: invoices.length + 1,
                invoiceNo,
                date: invoiceDate,
                month: invoiceMonth,
                daysInMonth,
                annualFixedCost,
                taxableValue,
                vat,
                grossInvoice
            };

            invoices.push(newInvoice);
            invoiceSequence++;
            renderInvoices();
            document.getElementById("invoiceForm").reset();
        });

        // Generate invoice number
        function generateInvoiceNo() {
            const year = settings.fiscalYear;
            const nextYear = (year + 1) % 100;
            const monthIndex = Array.from(document.getElementById("invoiceMonth").options).findIndex(opt => opt.value === document.getElementById("invoiceMonth").value);
            const seq = monthIndex < 1 ? invoiceSequence : String(monthIndex).padStart(2, "0");
            return settings.invoiceFormat
                .replace("{year}", year)
                .replace("{nextYear}", nextYear)
                .replace("{seq}", seq);
        }

        // Render invoices
        function renderInvoices() {
            const tbody = document.getElementById("invoiceTableBody");
            tbody.innerHTML = "";
            invoices.forEach(invoice => {
                const rebate = invoice.grossInvoice * 0.02;
                const tds = invoice.taxableValue * 0.10;
                const vat30 = invoice.vat * 0.30;
                const netReceipt = invoice.grossInvoice - rebate - tds - vat30;

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${invoice.invoiceNo}</td>
                    <td>${invoice.date}</td>
                    <td>${invoice.month}</td>
                    <td>${invoice.taxableValue.toLocaleString()}</td>
                    <td>${invoice.vat.toLocaleString()}</td>
                    <td>${invoice.grossInvoice.toLocaleString()}</td>
                    <td>${rebate.toLocaleString()}</td>
                    <td>${tds.toLocaleString()}</td>
                    <td>${vat30.toLocaleString()}</td>
                    <td>${netReceipt.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editInvoice(${invoice.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">Delete</button>
                        <button class="btn btn-sm btn-success" onclick="openPaymentModal(${invoice.id})">Pay</button>
                        <button class="btn btn-sm btn-info" onclick="previewInvoice(${invoice.id})">Invoice Preview</button>
                        <button class="btn btn-sm btn-secondary" onclick="previewPayment(${invoice.id})">Payment Preview</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit invoice
        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                document.getElementById("invoiceNo").value = invoice.invoiceNo;
                document.getElementById("invoiceDate").value = invoice.date;
                document.getElementById("invoiceMonth").value = invoice.month;
                document.getElementById("daysInMonth").value = invoice.daysInMonth;
                document.getElementById("annualFixedCost").value = invoice.annualFixedCost;
                deleteInvoice(id);
            }
        }

        // Delete invoice
        function deleteInvoice(id) {
            invoices = invoices.filter(inv => inv.id !== id);
            renderInvoices();
        }

        // Open payment modal
        function openPaymentModal(id) {
            document.getElementById("paymentInvoiceId").value = id;
            const modal = new bootstrap.Modal(document.getElementById("paymentModal"));
            modal.show();
        }

        // Handle payment form submission
        document.getElementById("paymentForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const invoiceId = parseInt(document.getElementById("paymentInvoiceId").value);
            const paymentDate = document.getElementById("paymentDate").value;
            const paymentAmount = parseFloat(document.getElementById("paymentAmount").value);
            const invoice = invoices.find(inv => inv.id === invoiceId);

            if (invoice) {
                const rebate = invoice.grossInvoice * 0.02;
                const tds = invoice.taxableValue * 0.10;
                const vat30 = invoice.vat * 0.30;
                const netPayment = invoice.grossInvoice - (rebate + tds + vat30);

                payments.push({
                    invoiceId,
                    paymentDate,
                    paymentAmount,
                    rebate,
                    tds,
                    vat30,
                    netPayment
                });
                alert(`Payment of NRs ${paymentAmount} recorded for Invoice ${invoice.invoiceNo}`);
            }
            document.getElementById("paymentForm").reset();
            bootstrap.Modal.getInstance(document.getElementById("paymentModal")).hide();
        });

        // Preview invoice
        function previewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const content = `
                <div class="invoice">
                    <h3>Power Transmission Company Nepal Limited</h3>
                    <p>Corporate Office: Lalitpur sub metropolitan city-2, Sanepa, Lalitpur, Nepal</p>
                    <p>Phone: +977-1-5544948, 5531907 | Fax: +977-1.5544948</p>
                    <p>PAN: 302889592</p>
                    <hr>
                    <h4>Invoice</h4>
                    <p><strong>To:</strong> Nepal Electricity Authority, Dubarmarg, Kathmandu, Nepal</p>
                    <p><strong>Invoice No:</strong> ${invoice.invoiceNo}</p>
                    <p><strong>Invoice Month:</strong> ${invoice.month}</p>
                    <p><strong>Date:</strong> ${invoice.date}</p>
                    <hr>
                    <h5>Amounts in NRs</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Annual Fixed Cost for the Year</td>
                                <td>${invoice.annualFixedCost.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Number of Days in the Month</td>
                                <td>${invoice.daysInMonth}</td>
                            </tr>
                            <tr>
                                <td>Taxable Value</td>
                                <td>${invoice.taxableValue.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>VAT @ 13%</td>
                                <td>${invoice.vat.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Gross Invoice</td>
                                <td>${invoice.grossInvoice.toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                    <hr>
                    <p><strong>Bank Details:</strong></p>
                    <p>Name of the Bank: Sanima Bank Limited</p>
                    <p>Branch Address: Newroad, Kathmandu</p>
                    <p>Account No: 003010010000710</p>
                    <p><strong>For Power Transmission Company Nepal Limited</strong></p>
                    <p>Authorised Signatory</p>
                    <p><strong>Note:</strong></p>
                    <p>1. The above Transmission Service Charges have been computed based on the Normative Availability @95% as per provision of Clause 9.6 of Section 9 of ITSA dtd 13th Dec, 2011.</p>
                </div>
            `;
            document.getElementById("invoicePreviewContent").innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById("invoicePreviewModal"));
            modal.show();
        }

        // Preview payment
        function previewPayment(id) {
            const invoice = invoices.find(inv => inv.id === id);
            const payment = payments.find(p => p.invoiceId === id) || {};
            if (!invoice) return;

            const rebate = invoice.grossInvoice * 0.02;
            const tds = invoice.taxableValue * 0.10;
            const vat30 = invoice.vat * 0.30;
            const netPayment = invoice.grossInvoice - (rebate + tds + vat30);

            const content = `
                <div class="payment">
                    <h3>Power Transmission Company Nepal Limited</h3>
                    <p>Corporate Office: Lalitpur sub metropolitan city-2, Sanepa, Lalitpur, Nepal</p>
                    <p>Phone: +977-1-5544948, 5531907 | Fax: +977-1.5544948</p>
                    <p>PAN: 302889592</p>
                    <hr>
                    <h4>Payment Information</h4>
                    <p><strong>Invoice No:</strong> ${invoice.invoiceNo}</p>
                    <p><strong>Payment Date:</strong> ${payment.paymentDate || "Not Paid"}</p>
                    <hr>
                    <h5>Amounts in NRs</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Gross Invoice</td>
                                <td>${invoice.grossInvoice.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Rebate @ 2%</td>
                                <td>${rebate.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>TDS @ 10%</td>
                                <td>${tds.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>30% VAT Deduction</td>
                                <td>${vat30.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Net Payment</td>
                                <td>${netPayment.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Amount Paid</td>
                                <td>${payment.paymentAmount ? payment.paymentAmount.toLocaleString() : "N/A"}</td>
                            </tr>
                        </tbody>
                    </table>
                    <hr>
                    <p><strong>Bank Details:</strong></p>
                    <p>Name of the Bank: Sanima Bank Limited</p>
                    <p>Branch Address: Newroad, Kathmandu</p>
                    <p>Account No: 003010010000710</p>
                </div>
            `;
            document.getElementById("paymentPreviewContent").innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById("paymentPreviewModal"));
            modal.show();
        }

        // Save as PDF
        function saveAsPDF(type) {
            const element = type === "invoice" ? document.getElementById("invoicePreviewContent") : document.getElementById("paymentPreviewContent");
            html2pdf().from(element).save(`${type}.pdf`);
        }

        // Save as Excel
        function saveAsExcel(type) {
            if (type === "invoice") {
                const invoiceData = invoices.map(inv => ({
                    "Invoice No": inv.invoiceNo,
                    "Date": inv.date,
                    "Month": inv.month,
                    "Annual Fixed Cost": inv.annualFixedCost,
                    "Days in Month": inv.daysInMonth,
                    "Taxable Value": inv.taxableValue,
                    "VAT @ 13%": inv.vat,
                    "Gross Invoice": inv.grossInvoice
                }));
                const ws = XLSX.utils.json_to_sheet(invoiceData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Invoice");
                XLSX.writeFile(wb, "invoice.xlsx");
            } else {
                const paymentData = payments.map(p => {
                    const inv = invoices.find(i => i.id === p.invoiceId);
                    return {
                        "Invoice No": inv.invoiceNo,
                        "Payment Date": p.paymentDate,
                        "Gross Invoice": inv.grossInvoice,
                        "Rebate @ 2%": p.rebate,
                        "TDS @ 10%": p.tds,
                        "30% VAT Deduction": p.vat30,
                        "Net Payment": p.netPayment,
                        "Amount Paid": p.paymentAmount
                    };
                });
                const ws = XLSX.utils.json_to_sheet(paymentData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Payment");
                XLSX.writeFile(wb, "payment.xlsx");
            }
        }

        // Backup data
        function backupData() {
            const data = { invoices, payments, settings, invoiceSequence };
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "invoice_backup.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        // Restore data
        function restoreData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = JSON.parse(e.target.result);
                    invoices = data.invoices || [];
                    payments = data.payments || [];
                    settings = data.settings || settings;
                    invoiceSequence = data.invoiceSequence || invoices.length + 1;
                    localStorage.setItem("settings", JSON.stringify(settings));
                    renderInvoices();
                    alert("Data restored successfully!");
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
